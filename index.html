<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sannu's Discipline Tracker — Optimized</title>
  <style>
    :root{
      --fg:#e9ecff; --muted:#b7bce7; --card: rgba(255,255,255,0.06);
      --card-border: rgba(255,255,255,0.12); --accent:#6d8cff; --accent-2:#00d4ff;
      --good:#22c55e; --bad:#ef4444; --radius:16px; --shadow:0 10px 30px rgba(0,0,0,0.35);
    }
    /* ------------- Page + Background ------------- */
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:var(--fg);background:#0f1226;}
    /* Blurred premium background layer — uses your uploaded image (background.jpg). 
       It is intentionally blurred + scaled to hide pixelation and avoid heavy repaints. */
    .bg-blur {
      position:fixed; inset:0; z-index:0; pointer-events:none; overflow:hidden;
      will-change:transform,opacity; /* hint to browser */
    }
    .bg-blur::before{
      content:"";
      position:absolute; inset:-10%; /* slightly bigger to avoid edges when scaled */
      background-image: url('background.jpg'); /* <-- put your uploaded image as background.jpg */
      background-size: cover;
      background-position: center;
      transform: scale(1.25);
      filter: blur(22px) saturate(0.8) contrast(0.9);
      opacity:0.86;
      will-change:transform,filter;
    }
    /* an additional gradient overlay to keep text readable */
    .bg-blur::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(7,9,20,0.45), rgba(6,8,18,0.6));
      mix-blend-mode: normal;
    }

    /* ------------- UI Shell ------------- */
    .topbar { position:sticky; top:0; z-index:30; backdrop-filter: blur(6px); background: rgba(6,8,20,0.45); border-bottom:1px solid var(--card-border); }
    .container { max-width:1100px; margin:0 auto; padding:12px 16px; display:flex; align-items:center; gap:12px; z-index:40; position:relative; }
    h1,h2,h3{margin:0}
    .btn { border:1px solid var(--card-border); background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); color:var(--fg); padding:8px 12px; border-radius:10px; cursor:pointer; }
    .btn.primary { background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#07102a; font-weight:700; }

    .sections { max-width:1100px; margin:18px auto 80px; padding:0 16px; position:relative; z-index:40; }
    .card { background:var(--card); border:1px solid var(--card-border); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow); }

    /* dashboard + chart */
    .dashboard { display:grid; grid-template-columns: repeat(4,1fr); gap:12px; margin-top:14px; }
    .dash-card { padding:12px; border-radius:10px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid var(--card-border); }
    @media (max-width:1000px){ .dashboard{ grid-template-columns: repeat(2,1fr);} }
    @media (max-width:640px){ .dashboard{ grid-template-columns: repeat(1,1fr);} }

    /* months grid */
    .months { display:grid; grid-template-columns: repeat(auto-fill, minmax(220px,1fr)); gap:12px; margin-top:12px; }
    .month.card { padding:12px; position:relative; overflow:visible; }
    .month-header { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .month-title { display:flex; flex-direction:column; }
    .progress{ margin-top:10px; height:10px; background: rgba(255,255,255,0.06); border-radius:999px; overflow:hidden; border:1px solid var(--card-border); }
    .progress>i{ display:block;height:100%; width:0%; background: linear-gradient(135deg,var(--good),var(--accent-2)); transition: width .5s cubic-bezier(.2,.9,.2,1); }

    .stats{ margin-top:8px; display:flex; justify-content:space-between; color:var(--muted); font-size:13px; gap:6px; flex-wrap:wrap; }

    .days{ margin-top:12px; display:grid; grid-template-columns: repeat(7,1fr); gap:8px; }
    .day{ aspect-ratio:1/1; border-radius:10px; border:1px solid var(--card-border); display:grid; place-items:center; cursor:pointer; font-weight:700; background:rgba(255,255,255,0.03); transition:transform .12s ease, box-shadow .12s ease; user-select:none;}
    .day:hover{ transform:translateY(-4px); box-shadow:0 8px 20px rgba(0,0,0,0.45); }
    .day.done{ background: linear-gradient(135deg, rgba(34,197,94,0.12), rgba(109,140,255,0.08)); border-color:rgba(34,197,94,0.35); color:#eafff1 }

    /* delete button */
    .delete-month { background:transparent; border:none; color:var(--bad); font-size:16px; cursor:pointer; padding:6px; border-radius:8px; }
    .delete-month:hover{ background: rgba(255,0,0,0.06); }

    /* modal */
    .modal-overlay{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:60; background: rgba(0,0,0,0.45); }
    .modal-card{ width:100%; max-width:480px; border-radius:12px; padding:14px; }

    /* toast */
    .toast { position:fixed; right:16px; bottom:16px; z-index:80; background:#0c1230; border:1px solid var(--card-border); color:var(--fg); padding:10px 12px; border-radius:10px; box-shadow:var(--shadow); opacity:0; transform:translateY(10px); transition:opacity .2s, transform .2s; pointer-events:none; }
    .toast.show{ opacity:1; transform:translateY(0); pointer-events:auto; }

    /* utilities */
    .muted{ color:var(--muted); font-size:13px; }
    a.action-link{ color:var(--accent-2); text-decoration:none; font-weight:600; }
    canvas{ width:100%; height:280px; border-radius:10px; background: rgba(255,255,255,0.02); display:block; }

    @media (max-width:480px){
      .container{ padding:10px }
      .months{ grid-template-columns: repeat(auto-fill, minmax(160px,1fr)); gap:8px; }
      canvas{ height:200px; }
    }
  </style>
</head>
<body>
  <!-- premium blurred background; uses local file background.jpg (place your uploaded image with this name) -->
  <div class="bg-blur" aria-hidden="true"></div>

  <header class="topbar">
    <div class="container">
      <div style="display:flex;align-items:center;gap:12px;">
        <img src="background.jpg" alt="profile" style="width:44px;height:44px;border-radius:8px;object-fit:cover;border:1px solid rgba(255,255,255,0.08);">
        <div>
          <div style="font-weight:700">Discipline Tracker</div>
          <div class="muted" style="font-size:12px">Sannu — stay consistent</div>
        </div>
      </div>
      <div style="flex:1"></div>
      <button id="addMonthBtn" class="btn primary">+ Add Month</button>
    </div>
  </header>

  <main class="sections">
    <h2>Start Learning</h2>
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
      <a class="btn" href="https://takeuforward.org/strivers-a2z-dsa-course/strivers-a2z-dsa-course-sheet-2" target="_blank">DSA</a>
      <a class="btn" href="https://www.udemy.com/cart/success/2150182161/" target="_blank">Machine Learning</a>
      <a class="btn" href="https://www.playbook.com/s/coderin/DXTziFdBPE6kEznPT9JsfGSA" target="_blank">Web Development</a>
      <a class="btn" href="https://www.youtube.com/feed/courses" target="_blank">GATE</a>
    </div>

    <section style="margin-top:18px;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
        <h2>Your Discipline Dashboard</h2>
        <div class="muted">Summary across months</div>
      </div>

      <div class="dashboard" id="dashboardArea" style="margin-top:12px;"></div>

      <div class="card" style="margin-top:12px;">
        <canvas id="progressChart" aria-label="Monthly progress chart"></canvas>
      </div>
    </section>

    <h2 style="margin-top:20px;">Your Months</h2>
    <div class="months" id="monthsGrid" style="margin-top:12px;"></div>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    /* ---------------- Constants & Helpers ---------------- */
    const STORAGE_KEY = 'discipline_tracker_v4';
    const monthsNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    const TASKS = {
      "DSA":"https://takeuforward.org/strivers-a2z-dsa-course/strivers-a2z-dsa-course-sheet-2",
      "Machine Learning":"https://www.udemy.com/cart/success/2150182161/",
      "Web Development":"https://www.freecodecamp.org/",
      "GATE Preparation":"https://www.youtube.com/feed/courses",
      "English Speaking":"https://www.talkenglish.com/"
    };
    const $ = (s, r=document) => r.querySelector(s);

    function load(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {months:{}} } catch(e){ return {months:{}}; } }
    function save(s){ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }

    /* ---------------- Toast (rate-limited) ---------------- */
    let toastTimer = null;
    function toast(msg, ms = 2200){
      const t = $('#toast');
      t.textContent = msg;
      t.classList.add('show');
      t.style.opacity = '1';
      if(toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>{ t.classList.remove('show'); t.style.opacity=''; toastTimer = null; }, ms);
    }

    /* ---------------- Chart management (single instance) ---------------- */
    let disChart = null;
    let pendingChartUpdate = false;
    function buildOrUpdateChart(labels, series){
      // if chart exists, update data only to avoid re-creation
      if(disChart){
        disChart.data.labels = labels;
        disChart.data.datasets[0].data = series;
        disChart.update();
        return;
      }
      const ctx = document.getElementById('progressChart').getContext('2d');
      disChart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{ label:'Monthly Accuracy %', data: series, borderColor:'#6d8cff', backgroundColor:'rgba(109,140,255,0.12)', fill:true, tension:0.3, pointRadius:4 }] },
        options: {
          responsive:true,
          maintainAspectRatio:false,
          scales:{ y:{ min:0, max:100, ticks:{ color:'#b7bce7' }, grid:{ color:'rgba(255,255,255,0.04)' } }, x:{ ticks:{ color:'#b7bce7' }, grid:{ color:'rgba(255,255,255,0.02)' } } },
          plugins:{ legend:{ labels:{ color:'#e9ecff' } } }
        }
      });
    }

    // Debounced window resize handler (200ms)
    let resizeTimer = null;
    window.addEventListener('resize', () => {
      if(resizeTimer) clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => { updateChartFromState(); resizeTimer=null; }, 200);
    });

    /* ---------------- Rendering ---------------- */
    function daysInMonth(y,m){ return new Date(y, m+1, 0).getDate(); }

    function render(){
      const st = load();
      renderMonths(st);
      renderDashboard(st);
      updateChartFromState(st);
    }

    function renderMonths(state){
      const grid = $('#monthsGrid');
      grid.innerHTML = '';
      // sort by newest first
      const entries = Object.values(state.months).sort((a,b)=> (b.year*100+b.month) - (a.year*100+a.month));
      if(entries.length === 0){
        grid.innerHTML = '<div class="muted card" style="padding:14px">No months yet — click Add Month to begin.</div>';
        return;
      }
      entries.forEach(m => {
        const uid = `${m.year}-${m.month}`;
        const card = document.createElement('div'); card.className = 'card month';
        // header
        const head = document.createElement('div'); head.className = 'month-header';
        const title = document.createElement('div'); title.className='month-title';
        title.innerHTML = `<strong>${monthsNames[m.month]} ${m.year}</strong><div class="muted" style="font-size:12px;margin-top:4px">${m.totalDays} days</div>`;
        const actions = document.createElement('div');
        const del = document.createElement('button'); del.className='delete-month'; del.textContent='✖';
        del.addEventListener('click', (e) => {
          e.stopPropagation();
          if(confirm(`Delete ${monthsNames[m.month]} ${m.year}? This will remove all data for this month.`)){
            const s = load(); delete s.months[uid]; save(s);
            toast('Month deleted');
            render();
          }
        });
        actions.appendChild(del);
        head.appendChild(title); head.appendChild(actions);
        card.appendChild(head);

        // progress + stats
        const prog = document.createElement('div'); prog.className='progress';
        const bar = document.createElement('i'); prog.appendChild(bar); card.appendChild(prog);
        const stats = document.createElement('div'); stats.className='stats'; card.appendChild(stats);

        // days
        const days = document.createElement('div'); days.className='days';
        for(let d=1; d<=m.totalDays; d++){
          const day = document.createElement('div'); day.className='day'; day.textContent = d;
          day.addEventListener('click', ()=> openTasksModal(m,d));
          days.appendChild(day);
        }
        card.appendChild(days);
        grid.appendChild(card);

        // once appended, mark done days & update progress
        markDoneDays(m, card);
        updateMonthProgress(m, bar, stats);
      });
    }

    function markDoneDays(m, cardRoot){
      const uid = `${m.year}-${m.month}`;
      const st = load();
      const monthData = st.months[uid] || {};
      const nodes = cardRoot.querySelectorAll('.day');
      nodes.forEach(node => {
        const d = +node.textContent;
        node.classList.remove('done');
        if(monthData.days && monthData.days[d]){
          const dayTasks = monthData.days[d].tasks || {};
          const anyDone = Object.keys(TASKS).some(t => !!dayTasks[t]);
          if(anyDone) node.classList.add('done');
        }
      });
    }

    function openTasksModal(m,d){
      const state = load();
      const uid = `${m.year}-${m.month}`;
      if(!state.months[uid].days) state.months[uid].days = {};
      if(!state.months[uid].days[d]) state.months[uid].days[d] = { tasks: {} };
      const dayData = state.months[uid].days[d];

      // create overlay elements only once per modal open (no global re-render)
      const overlay = document.createElement('div'); overlay.className='modal-overlay';
      const box = document.createElement('div'); box.className='card modal-card';
      box.innerHTML = `<h3>${monthsNames[m.month]} ${d}, ${m.year}</h3><div class="muted" style="margin-top:6px">Mark tasks you completed today</div>`;
      const taskBox = document.createElement('div'); taskBox.style.marginTop='10px';
      Object.entries(TASKS).forEach(([t,link])=>{
        const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.marginBottom='10px';
        const left = document.createElement('div'); left.style.display='flex'; left.style.alignItems='center'; left.style.gap='10px';
        const inp = document.createElement('input'); inp.type='checkbox'; inp.checked = !!dayData.tasks[t];
        inp.addEventListener('change', ()=>{
          dayData.tasks[t] = inp.checked ? true : false;
          if(!inp.checked) delete dayData.tasks[t];
          save(state);
        });
        const a = document.createElement('a'); a.href = link; a.target='_blank'; a.className='action-link'; a.textContent=t;
        left.appendChild(inp); left.appendChild(a);
        const right = document.createElement('div'); right.className='muted'; right.textContent = 'Open';
        row.appendChild(left); row.appendChild(right);
        taskBox.appendChild(row);
      });
      box.appendChild(taskBox);

      const actions = document.createElement('div'); actions.style.display='flex'; actions.style.justifyContent='flex-end'; actions.style.gap='8px'; actions.style.marginTop='12px';
      const closeBtn = document.createElement('button'); closeBtn.className='btn primary'; closeBtn.textContent='Close';
      closeBtn.addEventListener('click', ()=> { document.body.removeChild(overlay); render(); });
      actions.appendChild(closeBtn); box.appendChild(actions);
      overlay.appendChild(box);
      overlay.addEventListener('click', (ev)=> { if(ev.target === overlay){ document.body.removeChild(overlay); render(); } });
      document.body.appendChild(overlay);
    }

    function updateMonthProgress(m, bar, stats){
      const st = load();
      const uid = `${m.year}-${m.month}`;
      const md = st.months[uid] || {};
      let done=0, total=0;
      if(md.days){
        Object.values(md.days).forEach(d => { Object.keys(TASKS).forEach(t => { total++; if(d.tasks && d.tasks[t]) done++; }) });
      }
      const pct = Math.round((done / Math.max(1, total)) * 100);
      bar.style.width = pct + '%';
      stats.innerHTML = `<div>Accuracy: <strong>${pct}%</strong></div><div class="muted">${done}/${Math.max(1,total)} tasks</div>`;
    }

    function renderDashboard(state){
      const area = $('#dashboardArea');
      area.innerHTML = '';
      const months = Object.values(state.months);
      let totalDone = 0, totalPossible = 0;
      let best = null, worst = null;
      months.forEach(m => {
        const uid = `${m.year}-${m.month}`; const md = state.months[uid] || {};
        let done = 0, total = 0;
        if(md.days){
          Object.values(md.days).forEach(d => { Object.keys(TASKS).forEach(t => { total++; if(d.tasks && d.tasks[t]) done++; }) });
        }
        const pct = total === 0 ? 0 : Math.round((done/total)*100);
        if(best === null || pct > best.pct) best = { pct, label:`${monthsNames[m.month]} ${m.year}` };
        if(worst === null || pct < worst.pct) worst = { pct, label:`${monthsNames[m.month]} ${m.year}` };
        totalDone += done; totalPossible += total;
      });
      const overall = Math.round((totalDone/Math.max(1,totalPossible))*100);
      const pending = Math.max(0, totalPossible - totalDone);

      const c1 = document.createElement('div'); c1.className='dash-card'; c1.innerHTML = `<div class="muted">Overall Accuracy</div><div style="font-size:20px;font-weight:800;margin-top:6px">${overall}%</div><div class="muted" style="margin-top:6px">${totalDone}/${Math.max(1,totalPossible)} tasks</div>`;
      const c2 = document.createElement('div'); c2.className='dash-card'; c2.innerHTML = `<div class="muted">Best Month</div><div style="font-weight:700;margin-top:6px">${best?best.label:'—'}</div><div class="muted">${best?best.pct+'%':''}</div>`;
      const c3 = document.createElement('div'); c3.className='dash-card'; c3.innerHTML = `<div class="muted">Worst Month</div><div style="font-weight:700;margin-top:6px">${worst?worst.label:'—'}</div><div class="muted">${worst?worst.pct+'%':''}</div>`;
      const c4 = document.createElement('div'); c4.className='dash-card'; c4.innerHTML = `<div class="muted">Pending Tasks</div><div style="font-weight:800;margin-top:6px">${pending}</div><div class="muted" style="margin-top:6px">${months.length} months</div>`;

      area.appendChild(c1); area.appendChild(c2); area.appendChild(c3); area.appendChild(c4);

      // gentle prompt if low but rate-limited (only show once per render cycle)
      if(months.length && overall < 45) {
        // show toast once
        toast(`Overall Accuracy ${overall}%. Small steps daily = big wins!`);
      }
    }

    function updateChartFromState(providedState){
      const st = providedState || load();
      const entries = Object.values(st.months).sort((a,b)=> (a.year*100 + a.month) - (b.year*100 + b.month));
      const labels = []; const series = [];
      entries.forEach(m => {
        let done=0, total=0;
        if(m.days){
          Object.values(m.days).forEach(d => { Object.keys(TASKS).forEach(t => { total++; if(d.tasks && d.tasks[t]) done++; }) });
        }
        labels.push(`${monthsNames[m.month]} ${m.year}`);
        series.push(Math.round((done / Math.max(1,total)) * 100));
      });
      // Use requestAnimationFrame to schedule chart update in next frame (keeps UI responsive)
      if(!pendingChartUpdate){
        pendingChartUpdate = true;
        requestAnimationFrame(()=>{ buildOrUpdateChart(labels, series); pendingChartUpdate=false; });
      } else {
        // if an update is already pending, we still update data immediately (so next RAF uses latest)
        if(disChart){ disChart.data.labels = labels; disChart.data.datasets[0].data = series; }
      }
    }

    /* ---------------- Add Month ---------------- */
    function addMonth(){
      const y = prompt('Enter year:', new Date().getFullYear());
      const m = prompt('Enter month number (0-11):', new Date().getMonth());
      if(y === null || m === null) return;
      const st = load(); const uid = `${+y}-${+m}`;
      if(st.months[uid]) return toast('Month already exists');
      st.months[uid] = { year:+y, month:+m, totalDays: daysInMonth(+y, +m) };
      save(st); render(); toast('Month added');
    }

    /* ---------------- Init ---------------- */
    document.addEventListener('DOMContentLoaded', ()=> {
      // if no state, create current month as before
      if(!localStorage.getItem(STORAGE_KEY)){
        const d = new Date();
        const st = { months: {} };
        st.months[`${d.getFullYear()}-${d.getMonth()}`] = { year:d.getFullYear(), month:d.getMonth(), totalDays: daysInMonth(d.getFullYear(), d.getMonth()) };
        save(st);
      }
      // wire up add button
      $('#addMonthBtn').addEventListener('click', addMonth);
      // initial render
      render();
    });

    /* -------------- Performance tip for very small images -------------- 
      If you want even better visual quality for the stretched blurred background,
      you can replace 'background.jpg' with a slightly upscaled / higher-res image.
      But the blur + scale approach used above avoids pixelation while keeping performance smooth.
    */
  </script>
</body>
</html>
